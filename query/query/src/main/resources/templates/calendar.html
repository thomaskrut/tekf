<html>

<head>
    <title>Calendar</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/style.css}" />
</head>

<body x-data="{
    name: '',
    guests: 1,
    unitId: null,
    fromDate: null,
    toDate: null,
    fromDateParts: null,
    selectedCells: [],
    lastCell: null,
    selectionMade: false,

    clickDate: function(td) {

        if (this.selectionMade) {
            this.selectionMade = false
            this.clear()
        }

        if (this.fromDate === null && !td.classList.contains('table-warning')) {
        const parts = td.id.split('-')
        this.fromDateParts = parts
        this.unitId = parts[0];
        this.fromDate = parts[1] + '-' + parts[2] + '-' + parts[3]
        td.classList.add('table-success')
        this.selectedCells.push(td)
        } else if (this.toDate === null) {
            this.clear()
        } else {
            this.selectionMade = true
            td.classList.remove('table-success')
        }

    },

    hoverDate: function(td) {

        if (this.selectionMade) return
        if (this.fromDate === null) return

        const parts = td.id.split('-')
        unitId = parts[0];

        if (this.unitId !== unitId) {
            this.clear()
            return
        }

        if (Number(this.fromDateParts[4]) > Number(parts[4])) {
            this.clear()
            return
        }

        if (td.classList.contains('table-success')) {
            this.lastCell.classList.remove('table-success')
            this.toDate = parts[1] + '-' + parts[2] + '-' + parts[3]
            if (this.toDate == this.fromDate) this.toDate = null
            this.lastCell = td
            return
        }

        if (this.lastCell !== null && this.lastCell.classList.contains('table-warning') && Number(this.fromDateParts[4]) < Number(parts[4])) {
            this.clear()
            return
        }

        if (td.classList.contains('table-warning') && Number(this.fromDateParts[4]) < Number(parts[4])) {
            td.classList.add('table-success')
            this.toDate = parts[1] + '-' + parts[2] + '-' + parts[3]
            this.lastCell = td
            this.selectedCells.push(td)
            return
        }

        if (!td.classList.contains('table-success') && Number(this.fromDateParts[4]) < Number(parts[4])) {
            this.lastCell = td
            td.classList.add('table-success')
            this.toDate = parts[1] + '-' + parts[2] + '-' + parts[3]
            this.selectedCells.push(td)
            return
        }
    },

    clear: function() {
        this.selectedCells.forEach(cell => {
            cell.classList.remove('table-success')
        })
        this.fromDate = null
        this.toDate = null
        this.unitId = null
        this.lastCell = null
    },

    post: function() {
        if (this.fromDate === null || this.toDate === null) return
        const data = {
            name: this.name,
            unitId: Number(this.unitId),
            from: this.fromDate,
            to: this.toDate,
            guests: Number(this.guests)
        }
        fetch('http://localhost:8080/booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (response.ok) {
                this.clear()
                this.fromDateParts = null
                this.selectionMade = false
                this.selectedCells = []
                this.lastCell = null
                window.location.reload()
            } else {
                alert('Booking failed: ' + response.status)
            }
        })
    }

    }">
    <nav class="navbar navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <form class="form-inline" @submit.prevent="post()">

                <label for="unitId">Unit: </label>
                <input x-model="unitId" class="form-control form-control-sm m-2" type="text" aria-label="unitId"
                    readonly>

                <label for="fromDate">Check in: </label>
                <input x-model="fromDate" class="col-auto form-control form-control-sm m-2" type="text"
                    aria-label="fromDate" readonly>

                <label for="toDate">Check out: </label>
                <input x-model="toDate" class="form-control form-control-sm m-2" type="text" aria-label="toDate"
                    readonly>

                <label for="guests">Guests: </label>
                <input x-model="guests" class="form-control form-control-sm m-2" type="text" aria-label="toDate">

                <label for="guests">Name: </label>
                <input x-model="name" class="form-control form-control-sm m-2" type="text" aria-label="name">

                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Confirm</button>
            </form>
        </div>
        <div class="container-fluid">
            <table class="table table-hover m-0">
                <tr>
                    <th scope="row" style="min-width: 120px"></th>
                    <th scope="col" th:each="unit : ${units}" th:text="${unit}" style="width: 10%; text-align: center;">
                    </th>
                </tr>
            </table>
        </div>
    </nav>


    <div class="container-fluid" style="margin-top: 120px">
        <table class="table table-hover">


            <tr th:each="day, iStat : ${days}">


                <th scope="row" th:utext="${day.getWeekday() + '<br>' + day.getDate()}"
                    th:class="${day.isFirstDayOfMonth() ? 'border-top border-warning' : ''}" style="width: 120px">
                </th>

                <td @mouseenter="hoverDate($event.target)" @click="clickDate($event.target)" th:each="unit : ${units}"
                    th:id="${unit + '-' + day.getDate() + '-' + iStat.index}" class="date-cell"
                    th:class="${day.isFirstDayOfMonth() ? 'border-top border-warning' : ''}"
                    th:classappend="${day.getBookings().get(unit).getId() != '' ? 'table-warning' : 'table-default'}">
                </td>

            </tr>

        </table>
    </div>

</body>

</html>